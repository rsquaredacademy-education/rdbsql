# DBI {#dbi}

```{r libs, echo=FALSE, message=FALSE}
library(dbplyr)
library(dplyr)
library(DBI)
library(RSQLite)
```

## Introduction

In this chapter, we will learn to:

- connect to a SQLite database from R
- display database information
- list tables in the database
- query data 
    - read entire table
    - read few rows
    - read data in batches
- create table in database
- overwrite table in database
- append data to table in database
- remove table from database
- generate SQL query
- close database connection

We will use the following R packages:

- [DBI](http://rstats-db.github.io/DBI/)
- [RSQLite](https://rstats-db.github.io/RSQLite/)

All the data sets used in this chapter can be found [here](https://github.com/rsquaredacademy/datasets) and code can be downloaded from [here](https://gist.github.com/rsquaredacademy/7d99eb52a0e44cd1f87c8689cf1a307d).

## Connection

The first step is to connect to a database. We will connect to an in memory
SQLite databse using `dbConnect()`.

```{r lite1}
con <- dbConnect(RSQLite::SQLite(), ":memory:")
```

```{r data, echo=FALSE, message=FALSE}
ecom1 <- readr::read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
ecom <- ecom1 %>% 
  slice(1:20) %>% 
  select(referrer, device, bouncers, n_visit, n_pages, duration)
copy_to(con, ecom)
```

### Connection Summary

We can get the more information about the connection using `summary()`.

```{r lite2}
summary(con)
```

### List Tables

Now that we are connected to a database, let us list all the tables present in it using
`dbListTables()`.

```{r lite3}
dbListTables(con)
```

### List Fields

Time to explore the `ecom` table in the database. Use `dbListFields()` to list all
the fields in the table.

```{r lite4}
dbListFields(con, "ecom")
```

## Querying Data

The main objectives of connecting to a database are to: 

- query data from the tables already present
- create new tables
- overwrite existing tables
- delete existing tables

Let us begin with querying data. We can do this in the following ways:

- read an entire table at once
- read few rows from a table
- read data in batches

### Entire Table

We can read an entire table from a database using `dbReadTable()`. 

```{r lite5}
dbReadTable(con, 'ecom')
```

In some cases, we may not need the entire table but only a specific number of rows.
Use `dbGetQuery()` and supply a SQL statement specifying the number of rows of
data to be read from the table. In the below example, we read ten rows of data from 
the `ecom` table.

### Few Rows

```{r lite6}
dbGetQuery(con, "select * from ecom limit 10")
```

In case of very large table, we can read data in batches using `dbSendQuery()` and
`dbFetch()`. We can mention the number of rows of data to be read while fetching the
data using the query generated by `dbGetQuery()`.

### Read Data in Batches

```{r lite7}
query <- dbSendQuery(con, 'select * from ecom')
result <- dbFetch(query, n = 15)
result
```

## Query

### Query Status

To know the status of a query, use `dbHasCompleted()`. It is very useful in
cases of queries that might take a long time to complete.

```{r lite8}
dbHasCompleted(query)
```

### Query Info

`dbGetInfo()` will return the following:

- the sql staement
- number of rows fetched
- number of rows modified/affected
- status of the query

```{r lite9}
dbGetInfo(query)
```

### Latest Query

To get the latest query, use `dbGetStatement()`.

```{r lite10}
dbGetStatement(query)
```

### Rows Fetched

To check the number of rows of data returned by a query, use `dbGetRowCount()`.

```{r lite11}
dbGetRowCount(query)
```

### Rows Affected

To know the number of rows modified or affected in the table, use `dbGetRowsAffected()`.

```{r lite12}
dbGetRowsAffected(query)
```

### Column Info

To know the name of the columns and their data types, use `dbColumnInfo()`.

```{r lite13}
dbColumnInfo(query)
```

## Create Table

So far we have explored querying data from an existing table. Now, let us turn our
attention to creating new tables in the database.

#### Introduction

To create a new table, use `dbWriteTable()`. It takes the following 3 arguments:

- connection name
- name of the new table
- data for the new table

```{r lite15} 
x <- 1:10
y <- letters[1:10]
trial <- tibble::tibble(x, y)
dbWriteTable(con, "trial", trial)
```

Let us check if the new table has been created.

```{r lite16}
dbListTables(con)
dbExistsTable(con, "trial")
```

Let us query data from the new table.

```{r lite17}
dbGetQuery(con, "select * from trial limit 5")
```

#### Overwrite Table

In some cases, you may want to overwrite the data in an existing table. Use the
`overwrite` argument in `dbWriteTable()` and set it to `TRUE`.

```{r lite18}
x <- sample(100, 10)
y <- letters[11:20]
trial2 <- tibble::tibble(x, y)
dbWriteTable(con, "trial", trial2, overwrite = TRUE)
```

Let us see if the **trial** table has been overwritten.

```{r lite19}
dbGetQuery(con, "select * from trial limit 5")
```

## Append Data

You can append data to an existing table by setting the `append` argument in
`dbWriteTable()`  to `TRUE`.

```{r lite20}
x <- sample(100, 10)
y <- letters[5:14]
trial3 <- tibble::tibble(x, y)
dbWriteTable(con, "trial", trial3, append = TRUE)
```

Let us quickly check if the new data has been appended to the **trial** table.

```{r lite21}
dbReadTable(con, "trial")
```

We can also use `sqlAppendTable()` to append data to an existing table.

```{r lite28}
sqlAppendTable(con, "ecom", head(ecom))
```

## Insert Rows

#### Introduction

We can insert new rows into existing tables using:

- `dbExecute()`
- `dbSendStatement()`

Both the function take 2 arguments:

- connection name
- sql statement

```{r lite22, collapse = TRUE}
# use dbExecute
dbExecute(con,
  "INSERT into trial (x, y) VALUES (32, 'c'), (45, 'k'), (61, 'h')"
)

# use dbSendStatement
dbSendStatement(con,
  "INSERT into trial (x, y) VALUES (25, 'm'), (54, 'l'), (16, 'y')"
)
```

## Remove Table

If you want to delete/remove a table from the database, use `dbRemoveTable()`.

```{r lite25}
dbRemoveTable(con, "trial")
```

## SQLite Data Type

If you want to know the data type, use `dbDataType()`.

```{r lite24}
dbDataType(RSQLite::SQLite(), "a")
dbDataType(RSQLite::SQLite(), 1:5)
dbDataType(RSQLite::SQLite(), 1.5)
```

## Close Connection

It is a good practice to close connection to a database when you no longer need to 
read/write data from/to it. Use `dbDisconnect()` to close the database connection.

```{r lite29}
dbDisconnect(con)
```
